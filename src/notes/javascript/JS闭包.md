<!-- imageRoot:javascript -->

# JS 闭包

## 概念

1. 垃圾回收器，JS 引擎会不定时检索内存，查看`对象和变量的被引用情况`，若某个对象或变量在内存中`没有被引用`，该内存区域就会被回收。
2. 作用域链，简单理解，一对大括号`{}`内部的内容即为一个作用域，大括号的嵌套即构成了 JS 的作用域链，在多重大括号时，在内部引用变量将根据作用域链往外进行查找。JS 采用词法作用域，也叫静态作用域，函数的作用域链与定义的位置相关。

```js
let a1 = 1;
function f1() {
	let a2 = 2;
	return function f2() {
		let a3 = 3;
		let a1 = 11;
		return function f3() {
			let a4 = 4;
			return { a1, a2, a3, a4 };
		};
	};
}
console.log(f1()()());
console.log(a1);
/* 输出
{ a1: 11, a2: 2, a3: 3, a4: 4 }
1
*/
```

```js
//JS采用词法作用域，作用域链在词法分析时确定
let value = 1;

function foo() {
	console.log(value);
}

function bar() {
	let value = 2;
	foo();
}

bar();
```

3. 内部函数，我们可以在 JS 函数的内部声明内部函数，内部函数可以访问（即引用，使用）内部函数的作用域及其内部变量和对象，反之外部函数不可直接访问内部函数的信息。

```js
function foo() {
	let value = 'data';
	return function handler(operate) {
		operate(value);
	};
}

let valueHandler = foo();

valueHandler(console.log);
/*输出
data
*/
```

闭包即为闭包函数块+定义闭包函数块时的作用域链

访问了外部函数的内部函数`handler`称为`闭包函数`，通过闭包特性，我们可以将某个变量`value`声明为函数内部变量，同时借由闭包特性来获取它的`handler`函数。外部函数`foo`执行完毕时本该由垃圾回收器回收，但由于你保留了闭包函数`handler`的引用，而闭包函数又是对内部变量`value`的唯一引用（或者说的唯一的访问途径），因此该变量不会被回收，且已经拥有了`“私有”`特性，即除你的闭包函数`handler`外无法通过别的手段访问或修改。

## 优缺点

-   优点：
    1. 可以使得某个变量不被垃圾回收器回收
    2. 可以避免全局变量过多导致变量名污染，将部分变量名以闭包的形式挂在函数作用域里。
    3. 可以实现私有变量。
-   缺点：
    1. 使用不当会导致内存泄露，每次生成的闭包函数均有独立且完全相同的作用域链以及内容，占用大量内存。
